<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TicTacToe">
    <meta name="description" content="Strategic TicTacToe with AI and multiplayer">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <title>TicTacToe Advanced</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="./styles.css">
    
    <!-- Firebase SDKs -->
    <script>
        if (window.location.protocol !== 'file:') {
            const script1 = document.createElement('script');
            script1.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js';
            
            script1.onload = () => {
                const script2 = document.createElement('script');
                script2.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js';
                
                script2.onload = () => {
                    const configScript = document.createElement('script');
                    configScript.src = 'firebase-config.js';
                    document.head.appendChild(configScript);
                };
                document.head.appendChild(script2);
            };
            document.head.appendChild(script1);
        }
    </script>
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="./icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="./icon-512.png">
</head>
<body>
    <div class="container">
        <header>
            <h1>TicTacToe Advanced</h1>
            <p>Play against AI or challenge a friend!</p>
        </header>

        <div class="game-mode-selection" id="gameModeSelection">
            <h2>Choose Game Mode</h2>
            <div class="mode-buttons">
                <button class="mode-btn" onclick="startGame('ai')">
                    <span class="mode-icon">ü§ñ</span>
                    <span class="mode-text">Play vs AI</span>
                </button>
                <button class="mode-btn" onclick="startGame('multiplayer')">
                    <span class="mode-icon">üë•</span>
                    <span class="mode-text">Local Multiplayer</span>
                </button>
                <button class="mode-btn" onclick="showGameRoomModal()">
                    <span class="mode-icon">üåê</span>
                    <span class="mode-text">Online Multiplayer</span>
                </button>
            </div>
        </div>

        <!-- Game Room Modal -->
        <div class="modal" id="gameRoomModal" style="display: none;" onclick="handleModalBackdropClick(event)">
            <div class="modal-content" style="max-width: 400px;" onclick="event.stopPropagation()">
                <span class="close" onclick="closeGameRoomModal()" style="-webkit-tap-highlight-color: transparent; touch-action: manipulation;">&times;</span>
                <h2>Online Multiplayer</h2>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label for="playerNameInput" style="display: block; margin-bottom: 8px; font-weight: 600;">Your Name:</label>
                            <input type="text" id="playerNameInput" placeholder="Enter your name" maxlength="15" style="width: 100%; padding: 12px; border: 2px solid #E1E8ED; border-radius: 8px; font-size: 16px;">
                        </div>
                        <button id="createGameBtn" class="btn btn-primary" style="width: 100%; padding: 15px; margin-bottom: 10px; -webkit-tap-highlight-color: transparent; touch-action: manipulation;">
                            üéÆ Create New Game
                        </button>
                        <p style="text-align: center; color: #7F8C8D; font-size: 14px; margin: 15px 0;">OR</p>
                        <div style="margin-top: 15px;">
                            <label for="roomIdInput" style="display: block; margin-bottom: 8px; font-weight: 600;">Join Game Room:</label>
                            <input type="text" id="roomIdInput" placeholder="Enter Game ID" style="width: 100%; padding: 12px; border: 2px solid #E1E8ED; border-radius: 8px; font-size: 16px; margin-bottom: 10px;">
                            <button id="joinGameBtn" class="btn btn-secondary" style="width: 100%; padding: 12px; margin-bottom: 10px; -webkit-tap-highlight-color: transparent; touch-action: manipulation;">Join Game</button>
                        </div>
                        <button onclick="closeGameRoomModal()" class="btn btn-secondary" style="width: 100%; padding: 12px; background: #E74C3C; color: white; -webkit-tap-highlight-color: transparent; touch-action: manipulation;">
                            Cancel
                        </button>
                    </div>
                    <div id="roomStatus" style="text-align: center; padding: 10px; font-size: 14px; color: #7F8C8D;"></div>
                </div>
            </div>
        </div>

        <!-- Waiting Room (shown when created room, waiting for player 2) -->
        <div class="modal" id="waitingRoomModal" style="display: none;" onclick="handleModalBackdropClick(event)">
            <div class="modal-content" style="max-width: 400px;" onclick="event.stopPropagation()">
                <h2>Waiting for Opponent</h2>
                <div class="modal-body">
                    <p style="text-align: center; margin-bottom: 20px;">Share this Game ID:</p>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <input type="text" id="gameRoomIdDisplay" readonly style="flex: 1; padding: 12px; border: 2px solid #E1E8ED; border-radius: 8px; font-family: monospace; font-size: 18px; text-align: center; background: #F5F7FA;">
                        <button id="copyGameRoomBtn" class="btn btn-primary" style="-webkit-tap-highlight-color: transparent; touch-action: manipulation;">Copy</button>
                    </div>
                    <div id="waitingStatus" style="text-align: center; padding: 10px;">
                        <div class="spinner" style="margin: 20px auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p>Waiting for another player to join...</p>
                    </div>
                    <button onclick="cancelWaitingRoom()" class="btn btn-secondary" style="width: 100%; padding: 12px; margin-top: 15px; background: #E74C3C; color: white; -webkit-tap-highlight-color: transparent; touch-action: manipulation;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <div class="coin-flip-container" id="coinFlipContainer" style="display: none;">
            <h2>Coin Flip</h2>
            <p>Determining who goes first...</p>
            <div class="coin" id="coin">
                <div class="coin-side coin-green" id="coinGreen">
                </div>
                <div class="coin-side coin-red" id="coinRed">
                </div>
            </div>
            <div class="coin-result" id="coinResult" style="display: none;">
                <h3 id="coinResultText"></h3>
                <button class="control-btn" onclick="proceedToGame()">Start Game</button>
            </div>
        </div>

        <div class="game-container" id="gameContainer" style="display: none;">
            <div class="game-info">
                <div class="current-player" id="currentPlayer">
                    <span class="player-color-indicator" id="playerColorIndicator"></span>
                    <span class="player-name" id="playerName">Player 1's Turn</span>
                </div>
                <div class="game-stats">
                    <div class="stat">
                        <span class="stat-label">Player Wins:</span>
                        <span class="stat-value" id="playerWins">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">Draws:</span>
                        <span class="stat-value" id="draws">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">AI/Player2 Wins:</span>
                        <span class="stat-value" id="opponentWins">0</span>
                    </div>
                </div>
            </div>

            <div class="game-area">
                <div class="player-deck left-deck" id="player1Deck">
                    <h3>Player 1 Cards</h3>
                    <div class="deck-container" id="player1DeckContainer">
                        <!-- Player 1 cards will be dynamically generated here -->
                    </div>
                </div>

                <div class="game-board" id="gameBoard">
                    <div class="cell" data-index="0"></div>
                    <div class="cell" data-index="1"></div>
                    <div class="cell" data-index="2"></div>
                    <div class="cell" data-index="3"></div>
                    <div class="cell" data-index="4"></div>
                    <div class="cell" data-index="5"></div>
                    <div class="cell" data-index="6"></div>
                    <div class="cell" data-index="7"></div>
                    <div class="cell" data-index="8"></div>
                    <div class="cell" data-index="9"></div>
                    <div class="cell" data-index="10"></div>
                    <div class="cell" data-index="11"></div>
                    <div class="cell" data-index="12"></div>
                    <div class="cell" data-index="13"></div>
                    <div class="cell" data-index="14"></div>
                    <div class="cell" data-index="15"></div>
                </div>

                <div class="player-deck right-deck" id="player2Deck">
                    <h3>Player 2/AI Cards</h3>
                    <div class="deck-container" id="player2DeckContainer">
                        <!-- Player 2/AI cards will be dynamically generated here -->
                    </div>
                </div>
            </div>

            <div class="game-controls">
                <button class="control-btn" onclick="resetGame()">New Game</button>
                <button class="control-btn" onclick="changeGameMode()">Change Mode</button>
                <button class="control-btn share-btn" id="shareGameBtn" onclick="shareGame()" style="display: none;">üì§ Share Game</button>
            </div>
        </div>

        <div class="game-result" id="gameResult" style="display: none;">
            <h2 id="resultMessage"></h2>
            
            <!-- Emote Section for Online Multiplayer -->
            <div id="emoteSection" style="display: none; margin: 20px 0;">
                <p style="font-size: 14px; color: #7F8C8D; margin-bottom: 10px;">Send a reaction:</p>
                <div class="emote-buttons" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="emote-btn" onclick="sendEmote('üòä')" title="Happy">üòä</button>
                    <button class="emote-btn" onclick="sendEmote('üòÑ')" title="Laughing">üòÑ</button>
                    <button class="emote-btn" onclick="sendEmote('ü§î')" title="Thinking">ü§î</button>
                    <button class="emote-btn" onclick="sendEmote('üëç')" title="Good Game">üëç</button>
                    <button class="emote-btn" onclick="sendEmote('üéâ')" title="Celebrate">üéâ</button>
                    <button class="emote-btn" onclick="sendEmote('üò¢')" title="Sad">üò¢</button>
                    <button class="emote-btn" onclick="sendEmote('üñï')" title="Middle Finger">üñï</button>
                </div>
                <div id="receivedEmote" style="margin-top: 15px; font-size: 24px; min-height: 35px; text-align: center; animation: popIn 0.3s ease;">
                    <!-- Received emote will appear here -->
                </div>
            </div>
            
            <button class="control-btn" onclick="resetGame()">Play Again</button>
            <button class="control-btn" onclick="changeGameMode()">Change Mode</button>
        </div>
    </div>

    <script src="./script.js"></script>
</body>
</html>
